import{a as ee,b as te,u as F,N as O,d as ae}from"./search-form.vue_vue_type_script_setup_true_lang-Hz521IbE.js";import{bm as U,d as J,Q as q,R as L,o as M,c as z,w as r,f as a,h as t,$ as e,s as oe,z as x,B as C,bn as ne,P as w,bo as le,g as k,t as B,a9 as W,bp as G,bq as E,br as se,ag as H,bk as re,bl as ie,C as ue,ad as ce,b as pe,ae as V,af as me,O as de}from"./index-BztLELzb.js";import{_ as fe}from"./select-group.vue_vue_type_script_setup_true_lang-DXA2Evh-.js";import{_ as be}from"./task-batch-status.vue_vue_type_script_setup_true_lang-8L6H3MfM.js";import{_ as ge}from"./detail-drawer-CaKEzTf2.js";import{f as he,_ as _e}from"./log-CU3xmgB7.js";import{f as ke}from"./job-8fE21JLD.js";import{_ as Be,a as ye}from"./DescriptionsItem-gUlfoQM0.js";import{_ as Q}from"./Grid-DDhjb_3_.js";import"./group-XSuFGJhJ.js";function ve(i){return U({url:"/job/batch/list",method:"get",params:i})}function je(i){return U({url:`/job/batch/stop/${i}`,method:"post"})}function Se(i){return U({url:`/job/batch/retry/${i}`,method:"post"})}const we=J({name:"JobBatchSearch",__name:"job-batch-search",props:{model:{required:!0},modelModifiers:{}},emits:q(["reset","search"],["update:model"]),setup(i,{emit:j}){const b=j,p=L(i,"model");function y(){b("reset")}function N(){b("search")}return(T,d)=>{const v=ee,h=oe,f=te;return M(),z(f,{model:p.value,onSearch:N,onReset:y},{default:r(()=>[a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.groupName"),path:"groupName",class:"pr-24px"},{default:r(()=>[a(fe,{value:p.value.groupName,"onUpdate:value":d[0]||(d[0]=g=>p.value.groupName=g)},null,8,["value"])]),_:1},8,["label"]),a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.jobName"),path:"jobName",class:"pr-24px"},{default:r(()=>[a(h,{value:p.value.jobName,"onUpdate:value":d[1]||(d[1]=g=>p.value.jobName=g),placeholder:t(e)("page.jobBatch.form.jobName")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.taskBatchStatus"),path:"taskBatchStatus",class:"pr-24px"},{default:r(()=>[a(be,{value:p.value.taskBatchStatus,"onUpdate:value":d[2]||(d[2]=g=>p.value.taskBatchStatus=g)},null,8,["value"])]),_:1},8,["label"])]),_:1},8,["model"])}}});function Ne(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!H(i)}const De=J({name:"JobBatchDetailDrawer",__name:"job-batch-detail-drawer",props:q({rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{},logShow:{type:Boolean,default:!1},logShowModifiers:{}}),emits:["update:visible","update:logShow"],setup(i){var s,n;const j=i,b=x(),p=L(i,"visible"),y=L(i,"logShow"),{columns:N,data:T,loading:d,mobilePagination:v}=F({apiFn:ke,apiParams:{page:1,size:10,groupName:(s=j.rowData)==null?void 0:s.groupName,taskBatchId:(n=j.rowData)==null?void 0:n.id,startId:0,fromIndex:0},columns:()=>[{key:"index",title:e("common.index"),align:"center",width:64,render:o=>{async function u(){y.value=!0,b.value=o,await R()}return a(C,{type:"info",text:!0,onClick:u},{default:()=>[a("span",{class:"w-28px ws-break-spaces"},[e("page.log.view")])]})}},{key:"id",title:e("page.jobBatch.jobTask.id"),align:"left",minWidth:64},{key:"groupName",title:e("page.jobBatch.jobTask.groupName"),align:"left",minWidth:120},{key:"taskStatus",title:e("page.jobBatch.jobTask.taskStatus"),align:"left",minWidth:80,render:o=>{if(o.taskStatus===null)return null;const u=e(ne[o.taskStatus]);return a(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[o.taskStatus]},Ne(u)?u:{default:()=>[u]})}},{key:"clientInfo",title:e("page.jobBatch.jobTask.clientInfo"),align:"left",minWidth:120,render:o=>{var u;if(o.clientInfo){const c=(u=o.clientInfo)==null?void 0:u.split("@"),m=c.length>1?c[1]:"";return a("div",null,[m])}return a("div",null,[o.clientInfo])}},{key:"argsStr",title:e("page.jobBatch.jobTask.argsStr"),align:"left",minWidth:120},{key:"resultMessage",title:e("page.jobBatch.jobTask.resultMessage"),align:"left",minWidth:120},{key:"retryCount",title:e("page.jobBatch.jobTask.retryCount"),align:"left",minWidth:64},{key:"createDt",title:e("page.jobBatch.jobTask.createDt"),align:"left",minWidth:120}]}),h=x([]),f=x(),g=new AbortController,D=x(!1);let S="0",I=0;async function R(){const{data:o,error:u}=await he({taskBatchId:b.value.taskBatchId,jobId:b.value.jobId,taskId:b.value.id,startId:S,fromIndex:I,size:50});u||(D.value=o.finished,S=o.nextStartId,I=o.fromIndex,o.message&&(h.value.push(...o.message),h.value.sort((c,m)=>Number.parseInt(c.time_stamp,10)-Number.parseInt(m.time_stamp,10))),D.value||(clearTimeout(f.value),f.value=setTimeout(R,1e3)))}const P=()=>{D.value=!0,g.abort(),clearTimeout(f.value),f.value=void 0};return le(()=>{P()}),(o,u)=>{const c=Be,m=ye,A=re,K=Q,X=ie,Y=_e,Z=ge;return M(),z(Z,{modelValue:p.value,"onUpdate:modelValue":u[2]||(u[2]=l=>p.value=l),title:t(e)("page.jobBatch.detail"),width:["50%","90%"]},{default:r(()=>[a(X,{type:"segment",animated:""},{default:r(()=>[a(A,{name:0,tab:t(e)("page.log.info")},{default:r(()=>[a(m,{"label-placement":"top",bordered:"",column:2},{default:r(()=>[a(c,{label:t(e)("page.jobBatch.groupName")},{default:r(()=>{var l;return[k(B((l=o.rowData)==null?void 0:l.groupName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.jobName")},{default:r(()=>{var l;return[k(B((l=o.rowData)==null?void 0:l.jobName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.taskBatchStatus")},{default:r(()=>{var l;return[a(t(w),{type:t(W)((l=o.rowData)==null?void 0:l.taskBatchStatus)},{default:r(()=>{var _;return[k(B(t(e)(t(G)[(_=o.rowData)==null?void 0:_.taskBatchStatus])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executionAt")},{default:r(()=>{var l;return[k(B((l=o.rowData)==null?void 0:l.executionAt),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.operationReason")},{default:r(()=>{var l;return[a(t(w),{type:t(W)((l=o.rowData)==null?void 0:l.operationReason)},{default:r(()=>{var _;return[k(B(t(e)(t(E)[(_=o.rowData)==null?void 0:_.operationReason])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorType")},{default:r(()=>{var l;return[a(t(w),{type:t(W)((l=o.rowData)==null?void 0:l.executorType)},{default:r(()=>{var _;return[k(B(t(e)(t(se)[(_=o.rowData)==null?void 0:_.executorType])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorInfo"),span:2},{default:r(()=>{var l;return[k(B((l=o.rowData)==null?void 0:l.executorInfo),1)]}),_:1},8,["label"]),a(c,{label:t(e)("common.createDt"),span:2},{default:r(()=>{var l;return[k(B((l=o.rowData)==null?void 0:l.createDt),1)]}),_:1},8,["label"])]),_:1})]),_:1},8,["tab"]),a(A,{name:1,tab:t(e)("page.log.title"),"display-directive":"if"},{default:r(()=>[a(K,{columns:t(N),data:t(T),loading:t(d),remote:"","row-key":l=>l.id,pagination:t(v),class:"sm:h-full"},null,8,["columns","data","loading","row-key","pagination"])]),_:1},8,["tab"])]),_:1}),a(Y,{modelValue:h.value,"onUpdate:modelValue":u[0]||(u[0]=l=>h.value=l),show:y.value,"onUpdate:show":u[1]||(u[1]=l=>y.value=l),title:t(e)("page.log.title")},null,8,["modelValue","show","title"])]),_:1},8,["modelValue","title"])}}}),xe={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function $(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!H(i)}const Ue=J({name:"job_batch",__name:"index",setup(i){const j=ue(),b=x(),{bool:p,setTrue:y}=ce(!1),N=history.state.jobName,T=history.state.taskBatchStatus,{columnChecks:d,columns:v,data:h,getData:f,loading:g,mobilePagination:D,searchParams:S,resetSearchParams:I}=F({apiFn:ve,apiParams:{page:1,size:10,groupName:null,jobName:null,taskBatchStatus:null},searchParams:{jobName:N,taskBatchStatus:T},columns:()=>[{key:"id",title:e("common.index"),align:"center",width:120,render:s=>{function n(){b.value=s,y()}return a(C,{text:!0,tag:"a",type:"primary",onClick:n,class:"ws-normal"},{default:()=>[s.id]})}},{key:"groupName",title:e("page.jobBatch.groupName"),align:"left",minWidth:120},{key:"jobName",title:e("page.jobBatch.jobName"),align:"center",minWidth:120},{key:"executionAt",title:e("page.jobBatch.executionAt"),align:"center",minWidth:120},{key:"taskBatchStatus",title:e("page.jobBatch.taskBatchStatus"),align:"center",minWidth:120,render:s=>{if(s.taskBatchStatus===null)return null;const n=e(G[s.taskBatchStatus]);return a(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[s.taskBatchStatus]},$(n)?n:{default:()=>[n]})}},{key:"operationReason",title:e("page.jobBatch.operationReason"),align:"center",minWidth:120,render:s=>{if(s.operationReason===null)return null;const n=e(E[s.operationReason]);return a(w,{type:W(s.operationReason)},$(n)?n:{default:()=>[n]})}},{key:"createDt",title:e("common.createDt"),align:"center",minWidth:120},{key:"operate",title:e("common.operate"),align:"center",width:130,render:s=>a("div",{class:"flex-center gap-8px"},[s.taskBatchStatus===1||s.taskBatchStatus===2?a(O,{onPositiveClick:()=>P(s.id)},{default:()=>e("common.confirmStop"),trigger:()=>{let n;return a(C,{type:"error",text:!0,ghost:!0,size:"small"},$(n=e("common.stop"))?n:{default:()=>[n]})}}):"",s.taskBatchStatus===4||s.taskBatchStatus===5||s.taskBatchStatus===6?a(O,{onPositiveClick:()=>R(s.id)},{default:()=>e("common.confirmRetry"),trigger:()=>{let n;return a(C,{type:"error",text:!0,ghost:!0,size:"small"},$(n=e("common.retry"))?n:{default:()=>[n]})}}):""])}]});async function R(s){var o;const{error:n}=await Se(s);n||((o=window.$message)==null||o.success(e("common.operateSuccess")),f())}async function P(s){var o;const{error:n}=await je(s);n||((o=window.$message)==null||o.success(e("common.operateSuccess")),f())}return(s,n)=>{const o=ae,u=Q,c=de;return M(),pe("div",xe,[a(we,{model:t(S),"onUpdate:model":n[0]||(n[0]=m=>V(S)?S.value=m:null),onReset:t(I),onSearch:t(f)},null,8,["model","onReset","onSearch"]),a(c,{title:t(e)("page.jobBatch.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper","header-class":"view-card-header"},{"header-extra":r(()=>[a(o,{columns:t(d),"onUpdate:columns":n[1]||(n[1]=m=>V(d)?d.value=m:null),loading:t(g),"show-delete":!1,"show-add":!1,onRefresh:t(f)},null,8,["columns","loading","onRefresh"])]),default:r(()=>[a(u,{columns:t(v),data:t(h),"flex-height":!t(j).isMobile,"scroll-x":962,loading:t(g),remote:"","row-key":m=>m.id,pagination:t(D),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1},8,["title"]),t(p)?(M(),z(De,{key:0,visible:t(p),"onUpdate:visible":n[2]||(n[2]=m=>V(p)?p.value=m:null),"row-data":b.value},null,8,["visible","row-data"])):me("",!0)])}}});export{Ue as default};
